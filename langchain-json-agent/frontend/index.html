<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LangChain JSON Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      html,
      body {
        height: 100%;
        margin-left: 200px;
        margin-right: 200px;
        padding: 0;
      }
    </style>
  </head>

  <body class="flex flex-col h-full">
    <!-- Header -->
    <header
      class="bg-white shadow p-4 text-center text-2xl font-bold text-blue-700"
    >
      LangChain JSON Agent
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-4">
      <!-- Messages will appear here -->
    </main>

    <!-- Input -->
    <footer class="bg-white border-t p-4">
      <form id="query-form" class="flex gap-2 max-w-3xl mx-auto">
        <input
          id="query-input"
          type="text"
          placeholder="Type your question here..."
          class="flex-1 px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none"
          required
        />
        <button
          type="submit"
          class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition"
        >
          Ask
        </button>
      </form>
    </footer>

    <!-- Chat Logic -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("query-form");
        const input = document.getElementById("query-input");
        const chat = document.getElementById("chat-container");

        function addMessage(role, text) {
          const div = document.createElement("div");
          div.className = `max-w-2xl px-4 py-3 rounded-lg ${
            role === "user"
              ? "bg-blue-600 text-white self-end ml-auto"
              : "bg-gray-200 text-gray-800 self-start mr-auto"
          }`;
          div.textContent = text;
          chat.appendChild(div);
          chat.scrollTop = chat.scrollHeight;
        }

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const question = input.value.trim();
          if (!question) return;

          addMessage("user", question);
          input.value = "";

          // Add placeholder agent message
          addMessage("agent", "Thinking...");
          const agentMessage = [...chat.children]
            .reverse()
            .find((div) => div.textContent === "Thinking...");

          // Set fallback timeout
          const timeoutHandle = setTimeout(() => {
            if (agentMessage && agentMessage.textContent === "Thinking...") {
              agentMessage.textContent =
                "⏳ It is taking longer than expected...";
            }
          }, 10000); // 10 seconds

          try {
            const res = await fetch("http://localhost:8082/api/query/", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ question }),
            });

            const data = await res.json();

            clearTimeout(timeoutHandle); // cancel fallback if response came in time

            if (agentMessage)
              agentMessage.textContent = data.answer || "No answer.";
          } catch (err) {
            clearTimeout(timeoutHandle); // cancel fallback on error
            if (agentMessage)
              agentMessage.textContent = "❌ Error fetching response.";
          }
        });
      });
    </script>
  </body>
</html>
